<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<script src="https://cdn.staticfile.org/jquery/1.10.2/jquery.min.js"></script>
		
		<!-- jquery-loading v1.3.0 -->
		<link href="https://cdn.jsdelivr.net/npm/jquery-easy-loading@1.3.0/dist/jquery.loading.min.css" rel="stylesheet" />
		<script src="https://cdn.jsdelivr.net/npm/jquery-easy-loading@1.3.0/dist/jquery.loading.min.js"></script>
		
		<!-- jquery ui v1.12.1 -->
		<link rel="stylesheet" href="https://code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
		<script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
		<title>台灣空氣品質查詢系統</title>
	</head>
	<body>
		<h1 align="center">台灣空氣品質查詢系統</h1>
		
		<p align="center">
			<select id = "County"></select>
		</p>
		
		<table align="center" border = '1' id = "AQI"></table>
		
		<div id="DetailAQI" title="Basic dialog"></div>
	</body>
	<footer style = "background-color:black">
		<p align="center" style="font-size:40%; color:white" >作者:陳柏銓</p>
	</footer>
</html>


<script type="text/javascript">
	var County = new Array();
	var JsonData = new Object();
	
	$(function() {
		$("#DetailAQI").dialog({
			autoOpen: false,
			show: {
				effect: "blind",
				duration: 200
			},
			hide: {
				effect: "explode",
				duration: 200
			}
		});
	});
		
	$(document).ready(function(){
		$("body").loading(); //loading開始
		
		var requestURL = 'https://opendata.epa.gov.tw/api/v1/AQI?%24skip=0&%24top=1000&%24format=json';
		//var requestURL = 'opendata.epa.gov.tw/ws/Data/AQI/?$format=json';		//CORS
		$.get(requestURL,function(response){
			if(response.status = 200){
				JsonData = response;
				$.each(response,function(index,value){
					if(County.indexOf(value.County) == -1)
					{
						County.push(value.County);
						$("#County").append(`<option value = "${value.County}">${value.County}</option>`);
					}
				});
			}
			
			$("body").loading("stop") //loading停止
		});
	});
	
	$("#County").blur(function(){
		$("#AQI tr").remove();	//移除原搜尋資料
		
		$.each(JsonData,function(index,value){
			//console.log(this.County.toString());
			//console.log($("#County :selected").text());
			//console.log(this.County.toString() == $("#County :selected").text());
			if(this.County.toString() == $("#County :selected").text()){
				console.log(this);
				
				//var DetailData = JSON.stringify(value);
				$("#AQI").append(`<tr><td onclick="ShowAQI('${value.SiteName}')">
												觀測站:${value.SiteName}</br>
												AQI:${value.AQI}
										</td>
								</tr>`);
			}
		});
	});
	
	function ShowAQI(sitename){
		$("#DetailAQI").dialog("open");
		$.each(JsonData,function(index,value){
			if(this.SiteName.toString() == sitename){
				console.log();
				$(".ui-dialog-title").html(this.County + '-' + this.SiteName);
				$("#DetailAQI").append(`<p>CO:${this.CO}</p></br>
										<p>SO2:${this.SO2}</p></br>`)
			}
		});
	}
</script>